name: ğŸ” Test App Store Connect Authentication

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'app_store_connect_auth'
        type: choice
        options:
        - app_store_connect_auth
        - full_test

jobs:
  test-asc-auth:
    runs-on: macos-latest
    if: inputs.test_type == 'app_store_connect_auth'

    steps:
    - name: ğŸ Setup macOS Runner
      run: |
        echo 'ğŸ Running on self-hosted macOS runner'
        echo 'ğŸ“ Hostname: $(hostname)'
        echo 'ğŸ’° Using self-hosted runner (cost savings)'
        echo 'ğŸ–¥ï¸  macOS version: $(sw_vers -productVersion)'
        echo 'ğŸ› ï¸  Xcode version: $(xcodebuild -version | head -1)'

    - name: ğŸ”„ Remove Git SSH Redirects
      run: |
        echo 'ğŸ”„ Removing any global SSH redirects for GitHub to ensure HTTPS checkout works...'
        git config --global --unset-all url."git@github.com:".insteadOf || true
        echo 'âœ… Git config fixed for HTTPS checkout'

    - name: ğŸ“¦ Install GMP Library
      run: |
        echo 'ğŸ“¦ Installing GMP library...'
        brew install gmp
        echo 'âœ… GMP installed successfully'

    - name: ğŸ”§ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2
        bundler: 2.4.22

    - name: ğŸ“¦ Install Fastlane
      run: |
        echo 'ğŸ“¦ Installing Fastlane 2.230.0...'
        gem install fastlane -v 2.230.0
        echo 'ğŸ“¦ Installing CocoaPods...'
        gem install cocoapods
        fastlane --version
        echo 'âœ… Fastlane and CocoaPods installed successfully'

    - name: ğŸ” Setup Apple WWDR Certificate
      run: |
        echo 'ğŸ” Ensuring Apple WWDR intermediate certificate is available...'
        TMP_WWDR="/tmp/AppleWWDRCA.cer"
        rm -f "$TMP_WWDR" || true

        # Try multiple URLs for WWDR certificate
        for url in \
          "https://developer.apple.com/certificationauthority/AppleWWDRCAG3.cer" \
          "https://developer.apple.com/certificationauthority/AppleWWDRCA.cer"; do
          if curl -fsSL "$url" -o "$TMP_WWDR"; then
            echo "âœ… Downloaded WWDR certificate from: $url"
            break
          fi
        done

        if [ ! -s "$TMP_WWDR" ]; then
          echo 'âŒ Failed to download Apple WWDR certificate'
          exit 1
        fi

        # Import into login keychain
        security import "$TMP_WWDR" -k "$HOME/Library/Keychains/login.keychain-db" -T /usr/bin/codesign -T /usr/bin/security || true

        # Verify certificate presence
        security find-certificate -c "Apple Worldwide Developer Relations" "$HOME/Library/Keychains/login.keychain-db" >/dev/null 2>&1 \
          && echo 'âœ… WWDR certificate present in login keychain' \
          || echo 'âš ï¸ WWDR certificate verification inconclusive'

    - name: ğŸ” Validate App Store Connect Environment Variables
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      run: |
        echo 'ğŸ” Validating App Store Connect Environment Variables...'
        cat << 'EOF' | ruby
        puts "ğŸ” App Store Connect Environment Variables Validation"
        puts "=" * 50

        # Check APP_STORE_CONNECT_KEY_ID
        key_id = ENV['APP_STORE_CONNECT_KEY_ID']
        if key_id.nil? || key_id.empty?
          puts "âŒ APP_STORE_CONNECT_KEY_ID is missing or empty"
          puts "   ğŸ“ Fix: Add APP_STORE_CONNECT_KEY_ID secret to repository settings"
          exit 1
        else
          puts "âœ… APP_STORE_CONNECT_KEY_ID is present"
          puts "   ğŸ“‹ Value: #{key_id}"
          if key_id.match?(/^[\w]+$/)
            puts "   âœ… Format appears valid (alphanumeric)"
          else
            puts "   âš ï¸ Format may be invalid (should be alphanumeric)"
          end
        end

        # Check APP_STORE_CONNECT_ISSUER_ID
        issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
        if issuer_id.nil? || issuer_id.empty?
          puts "âŒ APP_STORE_CONNECT_ISSUER_ID is missing or empty"
          puts "   ğŸ“ Fix: Add APP_STORE_CONNECT_ISSUER_ID secret to repository settings"
          exit 1
        else
          puts "âœ… APP_STORE_CONNECT_ISSUER_ID is present"
          puts "   ğŸ¢ Value: #{issuer_id}"
          if issuer_id.match?(/^[\w-]+$/)
            puts "   âœ… Format appears valid (UUID-like)"
          else
            puts "   âš ï¸ Format may be invalid (should be UUID format)"
          end
        end

        # Check APP_STORE_CONNECT_KEY
        app_store_connect_key = ENV['APP_STORE_CONNECT_KEY']
        if app_store_connect_key.nil? || app_store_connect_key.empty?
          puts "âŒ APP_STORE_CONNECT_KEY is missing or empty"
          puts "   ğŸ“ Fix: Add APP_STORE_CONNECT_KEY secret to repository settings"
          puts "   ğŸ“– How: Download .p8 file from App Store Connect â†’ Copy entire content"
          exit 1
        else
          puts "âœ… APP_STORE_CONNECT_KEY is present"
          puts "   ğŸ”‘ Length: #{app_store_connect_key.length} characters"

          # Check for PEM headers
          has_begin = app_store_connect_key.include?("-----BEGIN PRIVATE KEY-----")
          has_end = app_store_connect_key.include?("-----END PRIVATE KEY-----")

          if has_begin && has_end
            puts "   âœ… Contains PEM headers (good)"
          elsif has_begin || has_end
            puts "   âš ï¸ Contains only one PEM header (may be incomplete)"
          else
            puts "   âš ï¸ No PEM headers found (may be base64 encoded)"
          end

          # Check for null bytes
          null_count = app_store_connect_key.count("\0")
          if null_count > 0
            puts "   âŒ Contains #{null_count} null byte(s) - THIS IS THE PROBLEM!"
            puts "   ğŸ“ Fix: Regenerate App Store Connect private key and copy cleanly"
            puts "   ğŸ” Null bytes often come from:"
            puts "      - Copying from formatted text editors"
            puts "      - Multi-line secret corruption in GitHub"
            puts "      - Invisible characters in the .p8 file"
            exit 1
          else
            puts "   âœ… No null bytes detected"
          end

          # Check for base64
          is_base64 = app_store_connect_key.match?(/\A[A-Za-z0-9+\/=]+\z/) && app_store_connect_key.length > 100
          if is_base64 && !has_begin
            puts "   â„¹ï¸ Appears to be base64 encoded (will be decoded)"
          end
        end

        puts ""
        puts "ğŸ‰ All App Store Connect environment variables are present and formatted correctly!"
        puts "   Next: Testing private key parsing..."
        EOF

    - name: ğŸ”„ Setup App Store Connect Authentication
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      run: |
        echo 'ğŸ”„ Setting up App Store Connect authentication...'

        # Create App Store Connect private key file
        mkdir -p ~/.private_keys
        echo '${{ secrets.APP_STORE_CONNECT_KEY }}' | base64 -d > ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 2>/dev/null || \
        echo '${{ secrets.APP_STORE_CONNECT_KEY }}' > ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

        # Verify the key was created
        if [ -f ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 ]; then
          echo 'âœ… App Store Connect private key file created successfully'
          echo "ğŸ“ File location: ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8"
          echo "ğŸ“ File size: $(wc -c < ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8) bytes"
          echo "ğŸ“„ First few lines:"
          head -3 ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          echo "ğŸ“„ Last few lines:"
          tail -3 ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
        else
          echo 'âŒ Failed to create App Store Connect private key file'
          exit 1
        fi

    - name: ğŸ” Test App Store Connect Private Key Parsing
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      run: |
        echo 'ğŸ” Testing App Store Connect Private Key Parsing...'
        cat << 'EOF' | ruby
        require 'openssl'

        key_id = ENV['APP_STORE_CONNECT_KEY_ID']
        issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
        private_key_path = "#{ENV['HOME']}/.private_keys/AuthKey_#{key_id}.p8"

        puts "ğŸ”‘ Testing private key file: #{private_key_path}"
        puts "ğŸ“‹ Key ID: #{key_id}"
        puts "ğŸ¢ Issuer ID: #{issuer_id}"

        # Check if file exists
        unless File.exist?(private_key_path)
          puts "âŒ Private key file does not exist: #{private_key_path}"
          puts "   ğŸ“ Fix: Check APP_STORE_CONNECT_KEY secret and file creation step"
          exit 1
        end

        begin
          private_key_content = File.read(private_key_path)
          puts "ğŸ“„ Key file content length: #{private_key_content.length} characters"

          # Show content preview (first 100 chars)
          puts "ğŸ“„ Content preview (first 100 chars):"
          puts "   #{private_key_content[0..99].inspect}"

          # Check for null bytes again
          null_count = private_key_content.count("\0")
          if null_count > 0
            puts "âŒ Found #{null_count} null byte(s) in private key file!"
            puts "   ğŸ“ Fix: The APP_STORE_CONNECT_KEY secret contains null bytes"
            puts "   ğŸ”„ Solution: Regenerate App Store Connect private key in App Store Connect"
            puts "   ğŸ“‹ Steps:"
            puts "      1. Go to App Store Connect â†’ Users and Access â†’ Keys"
            puts "      2. Delete existing private key"
            puts "      3. Create new private key (Admin role)"
            puts "      4. Download .p8 file immediately"
            puts "      5. Open in plain text editor (not VS Code)"
            puts "      6. Copy entire content including -----BEGIN/END-----"
            puts "      7. Paste into GitHub APP_STORE_CONNECT_KEY secret"
            exit 1
          end

          puts "âœ… No null bytes found in private key file"

          # Check for PEM format
          has_begin = private_key_content.include?("-----BEGIN PRIVATE KEY-----")
          has_end = private_key_content.include?("-----END PRIVATE KEY-----")

          unless has_begin && has_end
            puts "âš ï¸ Private key file missing PEM headers"
            puts "   Expected: -----BEGIN PRIVATE KEY----- and -----END PRIVATE KEY-----"
            puts "   ğŸ“ Fix: Ensure APP_STORE_CONNECT_KEY contains full PEM format"
          end

          # Try to parse the key
          puts "ğŸ” Attempting to parse private key with OpenSSL..."
          private_key = OpenSSL::PKey::EC.new(private_key_content)
          puts "âœ… Private key parsed successfully!"
          puts "  Key type: #{private_key.class}"
          puts "  Curve: #{private_key.group.curve_name}"

        rescue OpenSSL::PKey::ECError => e
          puts "âŒ Private key parsing failed: #{e.message}"
          puts ""
          puts "ğŸ” Troubleshooting:"
          case e.message
          when /string contains null byte/
            puts "   â€¢ NULL BYTES: The private key contains null characters"
            puts "   â€¢ SOLUTION: Regenerate ASC private key and copy cleanly"
          when /invalid curve name/
            puts "   â€¢ INVALID CURVE: The key format is corrupted"
            puts "   â€¢ SOLUTION: Download fresh .p8 file from App Store Connect"
          when /Neither PUB key nor PRIV key/
            puts "   â€¢ WRONG KEY TYPE: Need EC private key, got different type"
            puts "   â€¢ SOLUTION: Ensure downloading EC private key (.p8 file)"
          else
            puts "   â€¢ UNKNOWN ERROR: #{e.message}"
            puts "   â€¢ SOLUTION: Verify .p8 file is valid and complete"
          end
          puts ""
          puts "ğŸ“‹ Key content analysis:"
          puts "   Length: #{private_key_content.length} chars"
          puts "   Starts with: #{private_key_content[0..50]}..."
          puts "   Ends with: ...#{private_key_content[-50..-1]}"
          puts "   Contains BEGIN: #{private_key_content.include?('-----BEGIN')}"
          puts "   Contains END: #{private_key_content.include?('-----END')}"
          exit 1
        rescue => e
          puts "âŒ Unexpected error during key parsing: #{e.class} - #{e.message}"
          puts "   ğŸ“ Fix: Check APP_STORE_CONNECT_KEY secret format and .p8 file validity"
          exit 1
        end

        puts "ğŸ‰ Private key validation passed!"
        EOF

    - name: ğŸ”„ Test JWT Generation
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
      run: |
        echo 'ğŸ”„ Testing App Store Connect JWT authentication...'
        cat << 'EOF' | ruby
        require 'jwt'
        require 'openssl'

        key_id = ENV['APP_STORE_CONNECT_KEY_ID']
        issuer_id = ENV['APP_STORE_CONNECT_ISSUER_ID']
        private_key_path = "#{ENV['HOME']}/.private_keys/AuthKey_#{key_id}.p8"

        puts "ğŸ”„ Testing JWT token generation..."
        puts "ğŸ“‹ Using Key ID: #{key_id}"
        puts "ğŸ¢ Using Issuer ID: #{issuer_id}"

        begin
          # Load and parse private key
          private_key_content = File.read(private_key_path)
          private_key = OpenSSL::PKey::EC.new(private_key_content)
          puts "âœ… Private key loaded for JWT generation"

          # Create JWT payload
          now = Time.now.to_i
          payload = {
            iss: issuer_id,
            exp: now + 1200,  # 20 minutes from now
            aud: 'appstoreconnect-v1'
          }

          puts "ğŸ“ JWT Payload:"
          puts "   iss (issuer): #{issuer_id}"
          puts "   exp (expires): #{Time.at(payload[:exp])} (#{payload[:exp]})"
          puts "   aud (audience): #{payload[:aud]}"

          # Create JWT headers
          headers = {
            kid: key_id
          }

          puts "ğŸ“‹ JWT Headers:"
          puts "   kid (key ID): #{key_id}"

          # Generate JWT
          puts "ğŸ” Generating JWT token..."
          token = JWT.encode(payload, private_key, 'ES256', headers)

          puts 'âœ… JWT token generated successfully!'
          puts "  ğŸ“ Token length: #{token.length} characters"
          puts "  ğŸ” Token preview: #{token[0..50]}..."
          puts "  ğŸ“Š Token parts: #{token.split('.').length} (should be 3: header.payload.signature)"

          # Validate token structure
          parts = token.split('.')
          if parts.length != 3
            puts "âš ï¸ Token does not have 3 parts (header.payload.signature)"
          else
            puts "âœ… Token has correct 3-part structure"
          end

          # Test API connectivity
          puts 'ğŸŒ Testing App Store Connect API connectivity...'
          api_url = "https://api.appstoreconnect.apple.com/v1/apps"
          auth_header = "Bearer #{token}"

          # Use curl to test API (capture both stdout and stderr)
          require 'open3'
          stdout, stderr, status = Open3.capture3("curl", "-H", "Authorization: #{auth_header}",
                                                 "-H", "Accept: application/json",
                                                 api_url, "-o", "/dev/null", "-s", "-w", "%{http_code}")

          http_code = stdout.strip.to_i

          puts "ğŸ“¡ API Response Code: #{http_code}"

          case http_code
          when 200
            puts "âœ… App Store Connect API accessible (HTTP 200)"
            puts "ğŸ‰ App Store Connect authentication is working perfectly!"
          when 401
            puts "âŒ HTTP 401 Unauthorized - Authentication failed"
            puts "   ğŸ“ Possible causes:"
            puts "      â€¢ APP_STORE_CONNECT_KEY_ID or APP_STORE_CONNECT_ISSUER_ID incorrect"
            puts "      â€¢ Private key doesn't match the key ID"
            puts "      â€¢ Key has insufficient permissions (needs Admin role)"
            puts "   ğŸ”„ Fix: Verify key ID and issuer ID in App Store Connect"
          when 403
            puts "âŒ HTTP 403 Forbidden - Insufficient permissions"
            puts "   ğŸ“ Fix: Ensure App Store Connect private key has Admin role in App Store Connect"
          when 404
            puts "âš ï¸ HTTP 404 Not Found - API endpoint issue (may be normal)"
            puts "   This could be expected if no apps exist or endpoint has changed"
          else
            puts "âš ï¸ Unexpected HTTP #{http_code} response"
            puts "   Check App Store Connect service status"
          end

        rescue JWT::EncodeError => e
          puts "âŒ JWT encoding failed: #{e.message}"
          puts "   ğŸ“ Fix: Check private key format and JWT library compatibility"
          exit 1
        rescue OpenSSL::PKey::ECError => e
          puts "âŒ Private key error during JWT generation: #{e.message}"
          puts "   ğŸ“ Fix: Ensure private key is valid EC key for ES256 algorithm"
          exit 1
        rescue => e
          puts "âŒ Unexpected error during JWT generation: #{e.class} - #{e.message}"
          puts "   ğŸ“ Fix: Check all App Store Connect environment variables and key file"
          exit 1
        end

        puts ""
        puts "ğŸ‰ JWT authentication test completed!"
        EOF

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo 'ğŸ§¹ Cleaning up temporary files...'
        rm -rf ~/.private_keys
        rm -f ios/service-account-key.json
        echo 'âœ… Cleanup complete'

  full-test:
    runs-on: macos-latest
    if: inputs.test_type == 'full_test'

    steps:
    - name: ğŸ“ Note
      run: |
        echo "This would run the full iOS distribution workflow"
        echo "Use test_type: 'app_store_connect_auth' to test just App Store Connect authentication"