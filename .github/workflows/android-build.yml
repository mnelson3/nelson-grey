# Reusable Android Build and Distribution Workflow
# This workflow is called by project-specific workflows to build and distribute Android apps
#
# Usage in calling workflow:
#   - uses: ./.github/workflows/reusable/android-build.yml
#     with:
#       project_name: "vehicle-vitals"
#       build_type: "release"

name: Reusable Android Build & Distribution

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: "Name of the project (e.g., 'vehicle-vitals', 'modulo-squares')"
      mobile_dir:
        required: false
        type: string
        default: "packages/mobile"
        description: "Path to mobile directory"
      build_type:
        required: true
        type: string
        description: "Build type: debug or release"
      release_notes:
        required: false
        type: string
        description: "Release notes for this build"
      java_version:
        required: false
        type: string
        default: "17"
        description: "Java version for Android build"
      flutter_channel:
        required: false
        type: string
        default: "stable"
        description: "Flutter channel to use"
    secrets:
      firebase_service_account_key:
        required: false
        description: "Firebase service account key (JSON)"
      google_play_key_json:
        required: false
        description: "Google Play service account key"

jobs:
  build-android:
    name: Build Android App (${{ inputs.build_type }})
    runs-on: self-hosted
    environment:
      name: ${{ inputs.build_type == 'release' && 'PRODUCTION' || 'DEVELOPMENT' }}
    defaults:
      run:
        working-directory: ${{ inputs.mobile_dir }}
    steps:
      # 1. Environment and Prerequisites
      - name: ðŸ¤– Android Build Environment Check
        working-directory: .
        run: |
          echo "ðŸ¤– Running on self-hosted runner for Android builds"
          echo "ðŸ“ Hostname: $(hostname)"
          echo "ðŸ–¥ï¸  OS: $(uname -s)"
          echo "ðŸ’° Using self-hosted runner (cost savings)"

      - name: ðŸ”§ Fix Git Config for HTTPS Checkout
        working-directory: .
        run: |
          echo "ðŸ”„ Configuring Git for HTTPS checkout..."
          git config --global --unset-all url."git@github.com:".insteadOf || true
          echo "âœ… Git config ready"

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. Flutter Setup
      - name: ðŸ¦‹ Install Flutter SDK
        working-directory: .
        run: |
          echo "ðŸ¦‹ Installing Flutter SDK..."
          if [ ! -d "$HOME/flutter" ]; then
            cd $HOME
            git clone https://github.com/flutter/flutter.git -b ${{ inputs.flutter_channel }} --depth 1
            echo "$HOME/flutter/bin" >> $GITHUB_PATH
          fi
          export PATH="$HOME/flutter/bin:$PATH"
          flutter doctor -v
          echo "âœ… Flutter SDK installed"

      - name: ðŸ“¦ Get Flutter Dependencies
        working-directory: ${{ inputs.mobile_dir }}
        run: |
          export PATH="$HOME/flutter/bin:$PATH"
          flutter pub get

      # 3. Java Setup
      - name: â˜• Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ inputs.java_version }}

      # 4. Android SDK Setup
      - name: ðŸ”§ Setup Android SDK Manually
        run: |
          echo "ðŸ”§ Setting up Android SDK manually..."
          
          # Set default paths if not set
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-/root/.android/sdk}"
          export ANDROID_HOME="${ANDROID_HOME:-/root/.android/sdk}"
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          
          # Add to PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/tools/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
          
          # Try to accept licenses with graceful failure
          if [ -d "$ANDROID_SDK_ROOT" ]; then
            echo "Accepting Android licenses..."
            yes | sdkmanager --licenses 2>/dev/null || echo "âš ï¸ License acceptance skipped (non-critical)"
          fi
          
          echo "âœ… Android SDK environment prepared"

      - name: ðŸ—ï¸ Generate Android Platform Files
        working-directory: ${{ inputs.mobile_dir }}
        run: |
          echo "ðŸ—ï¸ Checking Android platform files..."
          if [ ! -d "android" ]; then
            echo "ðŸ“ Android directory not found, generating platform files..."
            flutter create --platforms=android .
          else
            echo "âœ… Android directory already exists, skipping generation"
          fi
          echo "âœ… Android platform files ready"

      # 5. Service Account Setup (if needed)
      - name: ðŸ“¦ Setup Firebase Service Account
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Setting up Firebase service account..."
          mkdir -p ${{ inputs.mobile_dir }}/android/app
          echo "${{ secrets.firebase_service_account_key }}" > ${{ inputs.mobile_dir }}/android/app/service-account-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ inputs.mobile_dir }}/android/app/service-account-key.json" >> $GITHUB_ENV
          echo "âœ… Firebase service account configured"

      - name: ðŸ“¦ Setup Google Play Service Account
        if: inputs.build_type == 'release'
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Setting up Google Play service account..."
          mkdir -p ${{ inputs.mobile_dir }}/android/app/google-play
          echo "${{ secrets.google_play_key_json }}" > ${{ inputs.mobile_dir }}/android/app/google-play/service-account-key.json
          echo "âœ… Google Play service account configured"

      # 6. Pre-Build Verification
      - name: ðŸ” Verify Flutter and Android Environment
        run: |
          export PATH="$HOME/flutter/bin:$PATH"
          echo "ðŸ” Pre-build environment verification..."
          
          echo "Flutter location:"
          which flutter || echo "âŒ flutter not in PATH"
          
          echo "Flutter version:"
          flutter --version || echo "âŒ flutter --version failed"
          
          echo "Dart version:"
          dart --version || echo "âŒ dart --version failed"
          
          echo "Android environment:"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          
          echo "PATH=$PATH"
          echo "âœ… Environment verification complete"

      # 7. Build Steps
      - name: ðŸ—ï¸ Build Android APK
        run: |
          export PATH="$HOME/flutter/bin:$PATH"
          cd ${{ inputs.mobile_dir }}
          echo "ðŸ—ï¸ Building Android ${{ inputs.build_type }} APK..."
          echo "ðŸ“ Working directory: $(pwd)"
          echo "ðŸ“ Files: $(ls -la | head -20)"

          case "${{ inputs.build_type }}" in
            debug)
              echo "ðŸ› Building debug APK..."
               flutter build apk --debug --verbose 2>&1 | tee build.log
               BUILD_EXIT=$?
              ;;
            release)
              echo "ðŸš€ Building release APK..."
               flutter build apk --release --verbose 2>&1 | tee build.log
               BUILD_EXIT=$?
              ;;
            *)
              echo "âŒ Unknown build type: ${{ inputs.build_type }}"
              exit 1
              ;;
          esac

           if [ $BUILD_EXIT -ne 0 ]; then
             echo "âŒ APK build failed with exit code $BUILD_EXIT"
             echo "ðŸ“‹ Build log tail:"
             tail -100 build.log 2>/dev/null || echo "Log file not found"
             exit $BUILD_EXIT
           fi
           echo "âœ… APK build complete"

      - name: ðŸ—ï¸ Build Android App Bundle
        if: inputs.build_type == 'release'
        run: |
          export PATH="$HOME/flutter/bin:$PATH"
          cd ${{ inputs.mobile_dir }}
          echo "ðŸ—ï¸ Building Android App Bundle for Google Play..."
          flutter build appbundle --release
          echo "âœ… App Bundle build complete"

      # 8. Artifact Collection
      - name: ðŸ“¦ Collect Build Artifacts
        if: success()
        run: |
          echo "ðŸ“¦ Collecting build artifacts..."
          mkdir -p ${{ runner.temp }}/artifacts

          if [ -f "${{ inputs.mobile_dir }}/build/app/outputs/flutter-apk/app-${{ inputs.build_type }}.apk" ]; then
            cp "${{ inputs.mobile_dir }}/build/app/outputs/flutter-apk/app-${{ inputs.build_type }}.apk" "${{ runner.temp }}/artifacts/"
            echo "ðŸ“± APK artifact collected"
          fi

          if [ -f "${{ inputs.mobile_dir }}/build/app/outputs/bundle/${inputs.build_type}Release/app-${inputs.build_type}.aab" ]; then
            cp "${{ inputs.mobile_dir }}/build/app/outputs/bundle/${inputs.build_type}Release/app-${inputs.build_type}.aab" "${{ runner.temp }}/artifacts/"
            echo "ðŸ“¦ App Bundle artifact collected"
          fi

      - name: ðŸ“¤ Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ inputs.build_type }}-build
          path: ${{ runner.temp }}/artifacts
          retention-days: 30

      # 9. Cleanup and Reporting
      - name: ðŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          rm -f ${{ inputs.mobile_dir }}/android/app/service-account-key.json
          rm -f ${{ inputs.mobile_dir }}/android/app/google-play/service-account-key.json
          echo "âœ… Cleanup complete"

      - name: ðŸ“Š Build Summary
        if: success()
        run: |
          echo "## âœ… Android Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.release_notes }}" ]; then
            echo "**Release Notes**: ${{ inputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âš ï¸ Build Failure Summary
        if: failure()
        run: |
          echo "## âŒ Android Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For debugging, see docs/TROUBLESHOOTING.md in nelson-grey repository" >> $GITHUB_STEP_SUMMARY
