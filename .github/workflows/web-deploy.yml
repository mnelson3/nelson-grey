# Reusable Web Deployment Workflow
# This workflow is called by project-specific workflows to deploy web apps to Firebase Hosting
#
# Usage in calling workflow:
#   - uses: ./.github/workflows/reusable/web-deploy.yml
#     with:
#       project_name: "vehicle-vitals"
#       environment: "staging"

name: Reusable Web Deployment

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: "Name of the project (e.g., 'vehicle-vitals')"
      web_dir:
        required: false
        type: string
        default: "packages/web"
        description: "Path to web directory"
      environment:
        required: true
        type: string
        description: "Environment: development, staging, or production"
      build_command:
        required: false
        type: string
        default: "npm run build"
        description: "Command to build the web app"
      node_version:
        required: false
        type: string
        default: "18"
        description: "Node.js version"
    secrets:
      firebase_token:
        required: true
        description: "Firebase CI token"
      firebase_project_dev:
        required: false
        description: "Firebase project ID for development"
      firebase_project_staging:
        required: false
        description: "Firebase project ID for staging"
      firebase_project_prod:
        required: false
        description: "Firebase project ID for production"

jobs:
  deploy-web:
    name: Deploy Web to ${{ inputs.environment }}
    runs-on: self-hosted
    environment:
      name: ${{ inputs.environment == 'production' && 'PRODUCTION' || inputs.environment == 'staging' && 'STAGING' || 'DEVELOPMENT' }}
    defaults:
      run:
        working-directory: ${{ inputs.web_dir }}
    steps:
      # 1. Environment and Prerequisites
      - name: ðŸŒ Web Deployment Environment Check
        working-directory: .
        run: |
          echo "ðŸŒ Running web deployment on self-hosted runner"
          echo "ðŸ“ Environment: ${{ inputs.environment }}"
          echo "ðŸ“ Hostname: $(hostname)"
          echo "ðŸ–¥ï¸  OS: $(uname -s)"

      - name: ðŸ”§ Fix Git Config for HTTPS Checkout
        working-directory: .
        run: |
          echo "ðŸ”„ Configuring Git for HTTPS checkout..."
          git config --global --unset-all url."git@github.com:".insteadOf || true
          echo "âœ… Git config ready"

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. Node.js Setup
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: ðŸ“¦ Install Firebase CLI
        run: |
          echo "ðŸ“¦ Installing Firebase CLI..."
          npm install -g firebase-tools
          firebase --version
          echo "âœ… Firebase CLI installed"

      # 3. Build Steps
      - name: ðŸ“¦ Install All Dependencies
        working-directory: .
        run: |
          echo "ðŸ“¦ Installing all dependencies (monorepo)..."
          npm ci --legacy-peer-deps 2>/dev/null || npm ci --force
          echo "âœ… All dependencies installed"

      - name: ðŸ“¦ Build Shared Packages
        working-directory: .
        run: |
          echo "ðŸ“¦ Building shared packages..."
          npm run build --workspace=@vehicle-vitals/shared 2>/dev/null || echo "âœ“ @vehicle-vitals/shared (skip)"
          npm run build --workspace=@modulo-squares/shared 2>/dev/null || echo "âœ“ @modulo-squares/shared (skip)"
          npm run build --workspace=@wishlist-wizard/shared 2>/dev/null || echo "âœ“ @wishlist-wizard/shared (skip)"
          npm run build --workspace=@shared/firebase-utils 2>/dev/null || echo "âœ“ @shared/firebase-utils (skip)"
          echo "âœ… Shared packages built"

      - name: ðŸ—ï¸ Build Web App
        working-directory: ${{ inputs.web_dir }}
        run: |
          echo "ðŸ—ï¸ Building web app for ${{ inputs.environment }}..."
          ${{ inputs.build_command }}
          echo "âœ… Web app built successfully"

      # 4. Environment Configuration
      - name: âš™ï¸ Configure Environment
        id: config
        run: |
          echo "âš™ï¸ Configuring deployment environment..."

          case "${{ inputs.environment }}" in
            production)
              if [ -z "${{ secrets.firebase_project_prod }}" ]; then
                echo "âŒ Firebase project ID for production not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_prod }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.prod.json" >> $GITHUB_OUTPUT
              echo "target=production" >> $GITHUB_OUTPUT
              ;;
            staging)
              if [ -z "${{ secrets.firebase_project_staging }}" ]; then
                echo "âŒ Firebase project ID for staging not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_staging }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.staging.json" >> $GITHUB_OUTPUT
              echo "target=staging" >> $GITHUB_OUTPUT
              ;;
            development|*)
              if [ -z "${{ secrets.firebase_project_dev }}" ]; then
                echo "âŒ Firebase project ID for development not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_dev }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.dev.json" >> $GITHUB_OUTPUT
              echo "target=development" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "âœ… Environment configured"

      # 5. Deploy to Firebase
      - name: ðŸ”¥ Deploy to Firebase Hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.firebase_token }}
        run: |
          echo "ðŸ”¥ Deploying to Firebase Hosting..."
          echo "ðŸ“ Project: ${{ steps.config.outputs.project_id }}"
          echo "ðŸ“ Target: ${{ steps.config.outputs.target }}"

          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "âŒ FIREBASE_TOKEN is not set"
            exit 1
          fi

          # Copy environment-specific config if it exists
          if [ -f "${{ steps.config.outputs.config_file }}" ]; then
            echo "ðŸ“‹ Using environment config: ${{ steps.config.outputs.config_file }}"
            cp "${{ steps.config.outputs.config_file }}" firebase.json
          fi

          # Deploy with explicit project
          firebase deploy \
            --project="${{ steps.config.outputs.project_id }}" \
            --token="$FIREBASE_TOKEN" \
            --message="Deployment from GitHub Actions for ${{ inputs.project_name }} to ${{ inputs.environment }}" \
            --non-interactive

          echo "âœ… Deployment successful"

      # 6. Reporting
      - name: ðŸ“Š Deployment Summary
        if: success()
        run: |
          echo "## âœ… Web Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Firebase Project**: ${{ steps.config.outputs.project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The web app is now live at your Firebase Hosting domain." >> $GITHUB_STEP_SUMMARY

      - name: âš ï¸ Deployment Failure Summary
        if: failure()
        run: |
          echo "## âŒ Web Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For debugging:" >> $GITHUB_STEP_SUMMARY
          echo "- Check FIREBASE_TOKEN is set correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Check Firebase project IDs in secrets" >> $GITHUB_STEP_SUMMARY
          echo "- Check build output directory" >> $GITHUB_STEP_SUMMARY
          echo "- See docs/TROUBLESHOOTING.md in nelson-grey repository" >> $GITHUB_STEP_SUMMARY

      # 7. Cache Cleanup
      - name: ðŸ§¹ Clean npm Cache
        if: always()
        run: npm cache clean --force 2>/dev/null || true
