# Reusable iOS Build and Distribution Workflow
# This workflow is called by project-specific workflows to build and distribute iOS apps
#
# Usage in calling workflow:
#   - uses: ./.github/workflows/reusable/ios-build.yml
#     with:
#       project_name: "vehicle-vitals"
#       release_type: "testflight"
#       release_notes: "Release notes here"

name: Reusable iOS Build & Distribution

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: "Name of the project (e.g., 'vehicle-vitals', 'modulo-squares')"
      mobile_dir:
        required: false
        type: string
        default: "packages/mobile"
        description: "Path to mobile directory"
      release_type:
        required: true
        type: string
        description: "Type of build: build_only, testflight, app_store, full_pipeline"
      release_notes:
        required: false
        type: string
        description: "Release notes for this build"
      beta_group_name:
        required: false
        type: string
        default: "Internal Testers"
        description: "TestFlight beta group name"
      ruby_version:
        required: false
        type: string
        default: "3.2"
        description: "Ruby version for Fastlane"
      bundler_version:
        required: false
        type: string
        default: "2.4.22"
        description: "Bundler version"
      fastlane_version:
        required: false
        type: string
        default: "2.230.0"
        description: "Fastlane version"
    secrets:
      app_store_connect_key_id:
        required: true
        description: "App Store Connect key ID"
      app_store_connect_issuer_id:
        required: true
        description: "App Store Connect issuer ID"
      app_store_connect_key:
        required: true
        description: "App Store Connect private key"
      fastlane_password:
        required: false
        description: "Fastlane password for App Store Connect"
      match_git_password:
        required: true
        description: "Password for match certificate repository"
      keychain_password:
        required: true
        description: "Password for macOS login keychain"
      match_git_url:
        required: true
        description: "Git URL for match certificates repository"
      match_git_branch:
        required: true
        description: "Git branch for match certificates"

jobs:
  build-ios:
    name: Build iOS App (${{ inputs.release_type }})
    runs-on: [self-hosted, macOS, ios]
    environment:
      name: ${{ (inputs.release_type == 'app_store' || inputs.release_type == 'full_pipeline') && 'PRODUCTION' || 'DEVELOPMENT' }}
    defaults:
      run:
        working-directory: ${{ inputs.mobile_dir }}
    steps:
      # 1. Environment and Prerequisites
      - name: ðŸŽ iOS Build Environment Check
        working-directory: .
        run: |
          echo "ðŸŽ Running on self-hosted macOS runner for iOS builds"
          echo "ðŸ“ Hostname: $(hostname)"
          echo "ðŸ–¥ï¸  macOS version: $(sw_vers -productVersion)"
          echo "ðŸ› ï¸  Xcode version: $(xcodebuild -version | head -1)"
          echo "ðŸ’° Using self-hosted runner (cost savings)"

      - name: ðŸ”§ Fix Git Config for HTTPS Checkout
        working-directory: .
        run: |
          echo "ðŸ”„ Configuring Git for HTTPS checkout..."
          git config --global --unset-all url."git@github.com:".insteadOf || true
          echo "âœ… Git config ready"

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â° Sync NTP Time
        run: |
          echo "ðŸ”„ Synchronizing system time with NTP..."
          sudo sntp -sS time.apple.com || sudo ntpdate -u time.apple.com || echo "âš ï¸ NTP sync failed, continuing..."

      # 2. Flutter Setup
      - name: ðŸ¦‹ Setup Flutter
        uses: subosito/flutter-action@v2.21.0
        with:
          channel: stable
          cache: false
          architecture: arm64

      - name: ðŸ“¦ Get Flutter Dependencies
        run: flutter pub get

      # 3. Ruby and Fastlane Setup
      - name: ðŸ”§ Install GMP (Ruby dependency)
        run: |
          echo "ðŸ“¦ Installing GMP library..."
          brew install gmp
          echo "âœ… GMP installed"

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ inputs.ruby_version }}
          bundler: ${{ inputs.bundler_version }}
          bundler-cache: true

      - name: ðŸ”§ Install Fastlane
        run: |
          echo "ðŸ“¦ Installing Fastlane ${{ inputs.fastlane_version }}..."
          gem install fastlane -v ${{ inputs.fastlane_version }}
          echo "ðŸ“¦ Installing CocoaPods..."
          gem install cocoapods
          fastlane --version
          echo "âœ… Fastlane and CocoaPods installed"

      # 4. Certificates and Code Signing
      - name: ðŸ” Install Apple WWDR Certificate
        run: |
          set -euo pipefail
          echo "ðŸ” Ensuring Apple WWDR intermediate certificate is available..."

          TMP_WWDR="/tmp/AppleWWDRCA.cer"
          rm -f "$TMP_WWDR" || true

          # Try multiple common URLs for WWDR certificate
          for url in \
            "https://developer.apple.com/certificationauthority/AppleWWDRCAG3.cer" \
            "https://developer.apple.com/certificationauthority/AppleWWDRCA.cer"; do
            if curl -fsSL "$url" -o "$TMP_WWDR"; then
              echo "âœ… Downloaded WWDR certificate from: $url"
              break
            fi
          done

          if [ ! -s "$TMP_WWDR" ]; then
            echo "âŒ Failed to download Apple WWDR certificate"
            exit 1
          fi

          # Import into login keychain
          security import "$TMP_WWDR" -k "$HOME/Library/Keychains/login.keychain-db" -T /usr/bin/codesign -T /usr/bin/security || true
          echo "âœ… WWDR certificate imported"

      - name: ðŸ” Setup App Store Connect Authentication
        run: |
          echo "ðŸ”„ Setting up App Store Connect authentication..."

          # Create ASC private key file
          ASC_KEY_FILE="$HOME/.appstoreconnect/key.p8"
          mkdir -p "$HOME/.appstoreconnect"
          echo "${{ secrets.app_store_connect_key }}" > "$ASC_KEY_FILE"
          chmod 600 "$ASC_KEY_FILE"
          echo "âœ… App Store Connect key configured"

      - name: ðŸ”“ Setup Match Certificate Store
        env:
          MATCH_GIT_PASSWORD: ${{ secrets.match_git_password }}
          MATCH_GIT_URL: ${{ secrets.match_git_url }}
          MATCH_GIT_BRANCH: ${{ secrets.match_git_branch }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.app_store_connect_key_id }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.app_store_connect_issuer_id }}
          APP_STORE_CONNECT_KEY_FILE: ${{ runner.temp }}/app_store_connect_key.json
        run: |
          echo "ðŸ”“ Configuring Fastlane match for certificates..."

          # Create App Store Connect key file for Fastlane
          cat > "$APP_STORE_CONNECT_KEY_FILE" <<EOF
          {
            "key_id": "$APP_STORE_CONNECT_KEY_ID",
            "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
            "key_filepath": "$HOME/.appstoreconnect/key.p8",
            "duration": 1200,
            "in_house": false
          }
          EOF

          echo "âœ… Match configuration ready"

      # 5. Build Steps
      - name: ðŸ—ï¸ Build iOS App
        env:
          MATCH_GIT_PASSWORD: ${{ secrets.match_git_password }}
          MATCH_PASSWORD: ${{ secrets.match_git_password }}  # Fastlane expects MATCH_PASSWORD for repo encryption
          MATCH_GIT_URL: ${{ secrets.match_git_url }}
          MATCH_GIT_BRANCH: ${{ secrets.match_git_branch }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.keychain_password }}
          # New standardized naming convention
          APP_STORE_CONNECT_KEY: ${{ secrets.app_store_connect_key }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.app_store_connect_key_id }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.app_store_connect_issuer_id }}
          APP_STORE_CONNECT_KEY_FILE: ${{ runner.temp }}/app_store_connect_key.json
          # Legacy names for backward compatibility with older Fastfiles
          ASC_PRIVATE_KEY: ${{ secrets.app_store_connect_key }}
          ASC_KEY_ID: ${{ secrets.app_store_connect_key_id }}
          ASC_ISSUER_ID: ${{ secrets.app_store_connect_issuer_id }}
        run: |
          echo "ðŸ—ï¸ Building iOS app for ${{ inputs.project_name }}..."

          case "${{ inputs.release_type }}" in
            build_only)
              echo "ðŸ“± Building for local testing..."
              flutter build ios --release --no-codesign
              ;;
            testflight)
              echo "ðŸ§ª Building for TestFlight..."
              cd ios
              fastlane beta beta_group_name="${{ inputs.beta_group_name }}" release_notes="${{ inputs.release_notes }}"
              ;;
            app_store)
              echo "ðŸª Building for App Store..."
              cd ios
              fastlane release release_notes="${{ inputs.release_notes }}"
              ;;
            full_pipeline)
              echo "ðŸ”„ Full pipeline: TestFlight then App Store..."
              cd ios
              fastlane beta beta_group_name="${{ inputs.beta_group_name }}" release_notes="${{ inputs.release_notes }}"
              fastlane release release_notes="${{ inputs.release_notes }}"
              ;;
            *)
              echo "âŒ Unknown release type: ${{ inputs.release_type }}"
              exit 1
              ;;
          esac

      # 6. Cleanup and Reporting
      - name: ðŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          rm -f "$HOME/.appstoreconnect/key.p8"
          rm -f "${{ runner.temp }}/app_store_connect_key.json"
          echo "âœ… Cleanup complete"

      - name: ðŸ“Š Build Summary
        if: success()
        run: |
          echo "## âœ… iOS Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.release_notes }}" ]; then
            echo "**Release Notes**: ${{ inputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âš ï¸ Build Failure Summary
        if: failure()
        run: |
          echo "## âŒ iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For debugging, see docs/TROUBLESHOOTING.md in nelson-grey repository" >> $GITHUB_STEP_SUMMARY
