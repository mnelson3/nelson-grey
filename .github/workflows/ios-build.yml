# Reusable iOS Build and Distribution Workflow
# This workflow is called by project-specific workflows to build and distribute iOS apps
#
# Usage in calling workflow:
#   - uses: ./.github/workflows/reusable/ios-build.yml
#     with:
#       project_name: "vehicle-vitals"
#       release_type: "testflight"
#       release_notes: "Release notes here"

name: Reusable iOS Build & Distribution

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: "Name of the project (e.g., 'vehicle-vitals', 'modulo-squares')"
      mobile_dir:
        required: false
        type: string
        default: "packages/mobile"
        description: "Path to mobile directory"
      release_type:
        required: true
        type: string
        description: "Type of build: build_only, testflight, app_store, full_pipeline"
      release_notes:
        required: false
        type: string
        description: "Release notes for this build"
      beta_group_name:
        required: false
        type: string
        default: "Internal Testers"
        description: "TestFlight beta group name"
      ruby_version:
        required: false
        type: string
        default: "3.2"
        description: "Ruby version for Fastlane"
      bundler_version:
        required: false
        type: string
        default: "2.4.22"
        description: "Bundler version"
      fastlane_version:
        required: false
        type: string
        default: "2.230.0"
        description: "Fastlane version"
    secrets:
      app_store_connect_key_id:
        required: true
        description: "App Store Connect key ID"
      app_store_connect_issuer_id:
        required: true
        description: "App Store Connect issuer ID"
      app_store_connect_key:
        required: true
        description: "App Store Connect private key"
      fastlane_password:
        required: false
        description: "Fastlane password for App Store Connect"
      match_git_password:
        required: true
        description: "Password for match certificate repository"
      keychain_password:
        required: true
        description: "Password for macOS login keychain"
      match_git_url:
        required: true
        description: "Git URL for match certificates repository"
      match_git_branch:
        required: true
        description: "Git branch for match certificates"

jobs:
  build-ios:
    name: Build iOS App (${{ inputs.release_type }})
    runs-on: [self-hosted, macOS, ios]
    environment:
      name: ${{ (inputs.release_type == 'app_store' || inputs.release_type == 'full_pipeline') && 'PRODUCTION' || 'DEVELOPMENT' }}
    defaults:
      run:
        working-directory: ${{ inputs.mobile_dir }}
    steps:
      # 1. Environment and Prerequisites
      - name: ðŸŽ iOS Build Environment Check
        working-directory: .
        run: |
          echo "ðŸŽ Running on self-hosted macOS runner for iOS builds"
          echo "ðŸ“ Hostname: $(hostname)"
          echo "ðŸ–¥ï¸  macOS version: $(sw_vers -productVersion)"
          echo "ðŸ› ï¸  Xcode version: $(xcodebuild -version)"
          echo "ðŸ’° Using self-hosted runner (cost savings)"

      - name: ðŸ”§ Fix Git Config for HTTPS Checkout
        working-directory: .
        run: |
          echo "ðŸ”„ Configuring Git for HTTPS checkout..."
          git config --global --unset-all url."git@github.com:".insteadOf || true
          echo "âœ… Git config ready"

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Set CocoaPods Home
        run: |
          echo "COCOAPODS_HOME=$RUNNER_TEMP/cocoapods" >> $GITHUB_ENV
          echo "CP_HOME_DIR=$RUNNER_TEMP/cocoapods" >> $GITHUB_ENV
          mkdir -p "$RUNNER_TEMP/cocoapods"

      - name: â° Sync NTP Time
        run: |
          echo "ðŸ”„ Synchronizing system time with NTP..."
          sudo sntp -sS time.apple.com || sudo ntpdate -u time.apple.com || echo "âš ï¸ NTP sync failed, continuing..."

      # 2. Flutter Setup
      - name: ðŸ¦‹ Install Flutter SDK
        working-directory: .
        run: |
          echo "ðŸ¦‹ Installing Flutter SDK..."
          if [ ! -d "$HOME/flutter" ]; then
            cd $HOME
            git clone https://github.com/flutter/flutter.git -b stable --depth 1
            echo "$HOME/flutter/bin" >> $GITHUB_PATH
          fi
          export PATH="$HOME/flutter/bin:$PATH"
          flutter doctor -v
          echo "âœ… Flutter SDK installed"

      - name: ðŸ“¦ Get Flutter Dependencies
        run: |
          export PATH="$HOME/flutter/bin:$PATH"
          flutter pub get

      # 3. Ruby and Fastlane Setup
      - name: ðŸ”§ Install GMP (Ruby dependency)
        run: |
          echo "ðŸ“¦ Installing GMP library..."
          brew install gmp
          echo "âœ… GMP installed"

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ inputs.ruby_version }}
          bundler: ${{ inputs.bundler_version }}
          bundler-cache: true

      - name: ðŸ”§ Install Fastlane
        run: |
          echo "ðŸ“¦ Installing Fastlane and CocoaPods..."
          gem install fastlane cocoapods
          fastlane --version
          echo "âœ… Fastlane and CocoaPods installed"

      - name: ðŸ“¦ Setup CocoaPods Cache
        run: |
          echo "ðŸ“¦ Setting up CocoaPods cache..."
          pod setup --no-shallow --progress 2>/dev/null || echo "âš ï¸ Pod setup skipped"
          echo "âœ… CocoaPods cache ready"

      # 4. Certificates and Code Signing
      - name: ðŸ” Install Apple WWDR Certificate
        run: |
          set -euo pipefail
          echo "ðŸ” Ensuring Apple WWDR intermediate certificate is available..."

          TMP_WWDR="/tmp/AppleWWDRCA.cer"
          rm -f "$TMP_WWDR" || true

          # Try multiple common URLs for WWDR certificate
          for url in \
            "https://developer.apple.com/certificationauthority/AppleWWDRCAG3.cer" \
            "https://developer.apple.com/certificationauthority/AppleWWDRCA.cer"; do
            if curl -fsSL "$url" -o "$TMP_WWDR"; then
              echo "âœ… Downloaded WWDR certificate from: $url"
              break
            fi
          done

          if [ ! -s "$TMP_WWDR" ]; then
            echo "âš ï¸ WWDR certificate download unavailable; continuing without import"
          else
            # Import into login keychain
            security import "$TMP_WWDR" -k "$HOME/Library/Keychains/login.keychain-db" -T /usr/bin/codesign -T /usr/bin/security || true
            echo "âœ… WWDR certificate imported"
          fi

      - name: ðŸ” Setup App Store Connect Authentication
        run: |
          echo "ðŸ”„ Setting up App Store Connect authentication..."

          # Create ASC private key file
          ASC_KEY_FILE="$HOME/.appstoreconnect/key.p8"
          mkdir -p "$HOME/.appstoreconnect"
          echo "${{ secrets.app_store_connect_key }}" > "$ASC_KEY_FILE"
          chmod 600 "$ASC_KEY_FILE"
          echo "âœ… App Store Connect key configured"

      - name: ï¿½ Create Fastlane Keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.keychain_password }}
        run: |
          echo "ðŸ” Creating dedicated keychain for Fastlane..."
          KEYCHAIN_NAME="fastlane_tmp_keychain"
          KEYCHAIN_PATH="$HOME/Library/Keychains/${KEYCHAIN_NAME}-db"

          echo "MATCH_KEYCHAIN_NAME=${KEYCHAIN_NAME}" >> $GITHUB_ENV
          echo "MATCH_KEYCHAIN_PATH=${KEYCHAIN_PATH}" >> $GITHUB_ENV
          echo "MATCH_KEYCHAIN_PASSWORD=${KEYCHAIN_PASSWORD}" >> $GITHUB_ENV

          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

      - name: ðŸ” Configure Keychain Access for Codesign
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.keychain_password }}
        run: |
          KEYCHAIN_NAME="fastlane_tmp_keychain"
          KEYCHAIN_PATH="$HOME/Library/Keychains/${KEYCHAIN_NAME}-db"

          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" || true

      - name: ï¿½ðŸ”“ Setup Match Certificate Store
        env:
          MATCH_GIT_PASSWORD: ${{ secrets.match_git_password }}
          MATCH_GIT_URL: ${{ secrets.match_git_url }}
          MATCH_GIT_BRANCH: ${{ secrets.match_git_branch }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.keychain_password }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.app_store_connect_key_id }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.app_store_connect_issuer_id }}
          APP_STORE_CONNECT_KEY_FILE: ${{ runner.temp }}/app_store_connect_key.json
        run: |
          echo "ðŸ”“ Configuring Fastlane match for certificates..."

          # Create App Store Connect key file for Fastlane
          cat > "$APP_STORE_CONNECT_KEY_FILE" <<EOF
          {
            "key_id": "$APP_STORE_CONNECT_KEY_ID",
            "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
            "key_filepath": "$HOME/.appstoreconnect/key.p8",
            "duration": 1200,
            "in_house": false
          }
          EOF

          echo "âœ… Match configuration ready"
            # Unlock keychain with KEYCHAIN_PASSWORD to enable certificate import
            KEYCHAIN_PATH="$HOME/Library/Keychains/login.keychain-db"
            if [ -f "$KEYCHAIN_PATH" ]; then
              echo "ðŸ”“ Unlocking keychain for certificate operations..."
              # Use printf to avoid shell interpretation of special characters
              printf '%s' '${{ secrets.keychain_password }}' | security unlock-keychain -p "$(cat -)" "$KEYCHAIN_PATH" || {
                echo "âš ï¸ Failed to unlock keychain with KEYCHAIN_PASSWORD"
                # Try alternative method with explicit password passing
                KEYCHAIN_PWD='${{ secrets.keychain_password }}'
                security unlock-keychain -p "${KEYCHAIN_PWD}" "$KEYCHAIN_PATH" || echo "âš ï¸ Keychain unlock failed, continuing..."
              }
              security set-keychain-settings -t 3600 "$KEYCHAIN_PATH" || true
            fi

            echo "âœ… Match configuration ready"

      - name: ðŸ”„ Update CocoaPods Specs Repo
        run: |
          echo "ðŸ”„ Updating CocoaPods specs repository..."
          # Completely clear CocoaPods cache
          rm -rf ~/.cocoapods/repos 2>/dev/null || true
          rm -rf ~/Library/Caches/CocoaPods 2>/dev/null || true
          
          # Use CDN with aggressive retries
          (
            for i in {1..3}; do
              echo "Attempt $i: Setting up CDN..."
              timeout 60 pod repo add-cdn trunk https://cdn.jsdelivr.net/cocoapods && break
              sleep 5
            done
            
            echo "Updating pod repo..."
            timeout 120 pod repo update || true
          ) || echo "âš ï¸ Pod repo setup skipped (pod install will attempt update)"
          
          echo "âœ… CocoaPods ready for installation"

      - name: ðŸ“¦ Update CocoaPods Dependencies
        run: |
          echo "ðŸ“¦ Updating CocoaPods dependencies to resolve version conflicts..."
          cd ios
          
          # Try to update FirebaseAppCheck specifically (common issue with Flutter Firebase plugins)
          if pod update FirebaseAppCheck --no-repo-update 2>/dev/null; then
            echo "âœ… FirebaseAppCheck updated successfully"
          else
            echo "âš ï¸ FirebaseAppCheck update failed, trying full pod install..."
            # If specific update fails, try a clean install
            rm -f Podfile.lock
            pod install --repo-update || pod install
          fi
          
          echo "âœ… CocoaPods dependencies updated"

      # 5. Build Steps
      - name: ðŸ—ï¸ Build iOS App
        env:
          MATCH_GIT_PASSWORD: ${{ secrets.match_git_password }}
          MATCH_PASSWORD: ${{ secrets.match_git_password }}  # Fastlane expects MATCH_PASSWORD for repo encryption
          MATCH_GIT_URL: ${{ secrets.match_git_url }}
          MATCH_GIT_BRANCH: ${{ secrets.match_git_branch }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.keychain_password }}
          # App Store Connect authentication
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.app_store_connect_key_id }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.app_store_connect_issuer_id }}
          APP_STORE_CONNECT_KEY: ${{ secrets.app_store_connect_key }}
          APP_STORE_CONNECT_KEY_FILE: ${{ runner.temp }}/app_store_connect_key.json
        run: |
          echo "ðŸ—ï¸ Building iOS app for ${{ inputs.project_name }}..."

          case "${{ inputs.release_type }}" in
            build_only)
              echo "ðŸ“± Building for local testing..."
              flutter build ios --release --no-codesign
              ;;
            testflight)
              echo "ðŸ§ª Building for TestFlight..."
              cd ios
              export RELEASE_NOTES="${{ inputs.release_notes }}"
              export BETA_FEEDBACK_EMAIL="${{ inputs.beta_feedback_email }}"
              export BETA_GROUP_NAME="${{ inputs.beta_group_name }}"
              fastlane beta
              ;;
            app_store)
              echo "ðŸª Building for App Store..."
              cd ios
              export RELEASE_NOTES="${{ inputs.release_notes }}"
              fastlane release
              ;;
            full_pipeline)
              echo "ðŸ”„ Full pipeline: TestFlight then App Store..."
              cd ios
              export RELEASE_NOTES="${{ inputs.release_notes }}"
              export BETA_FEEDBACK_EMAIL="${{ inputs.beta_feedback_email }}"
              export BETA_GROUP_NAME="${{ inputs.beta_group_name }}"
              fastlane beta
              fastlane release
              ;;
            *)
              echo "âŒ Unknown release type: ${{ inputs.release_type }}"
              exit 1
              ;;
          esac

      # 6. Cleanup and Reporting
      - name: ðŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          rm -f "$HOME/.appstoreconnect/key.p8"
          rm -f "${{ runner.temp }}/app_store_connect_key.json"
          echo "âœ… Cleanup complete"

      - name: ðŸ“¦ Upload Gym Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-gym-logs
          path: |
            ${{ runner.home }}/Library/Logs/gym/*.log
          if-no-files-found: warn

      - name: ðŸ“Š Build Summary
        if: success()
        run: |
          echo "## âœ… iOS Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.release_notes }}" ]; then
            echo "**Release Notes**: ${{ inputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âš ï¸ Build Failure Summary
        if: failure()
        run: |
          echo "## âŒ iOS Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For debugging, see docs/TROUBLESHOOTING.md in nelson-grey repository" >> $GITHUB_STEP_SUMMARY
