# Reusable Firebase Functions Deployment Workflow
# This workflow is called by project-specific workflows to deploy Firebase functions
#
# Usage in calling workflow:
#   - uses: ./.github/workflows/reusable/firebase-deploy.yml
#     with:
#       project_name: "wishlist-wizard"
#       environment: "staging"

name: Reusable Firebase Functions Deployment

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: "Name of the project"
      functions_dir:
        required: false
        type: string
        default: "packages/functions"
        description: "Path to functions directory"
      environment:
        required: true
        type: string
        description: "Environment: development, staging, or production"
      node_version:
        required: false
        type: string
        default: "18"
        description: "Node.js version"
      deploy_rules:
        required: false
        type: boolean
        default: false
        description: "Deploy Firestore rules as well"
    secrets:
      firebase_token:
        required: true
        description: "Firebase CI token"
      firebase_project_dev:
        required: false
        description: "Firebase project ID for development"
      firebase_project_staging:
        required: false
        description: "Firebase project ID for staging"
      firebase_project_prod:
        required: false
        description: "Firebase project ID for production"

jobs:
  deploy-firebase:
    name: Deploy Firebase to ${{ inputs.environment }}
    runs-on: self-hosted
    environment:
      name: ${{ inputs.environment == 'production' && 'PRODUCTION' || inputs.environment == 'staging' && 'STAGING' || 'DEVELOPMENT' }}
    steps:
      # 1. Environment and Prerequisites
      - name: ðŸ”¥ Firebase Deployment Environment Check
        run: |
          echo "ðŸ”¥ Running Firebase deployment on self-hosted runner"
          echo "ðŸ“ Environment: ${{ inputs.environment }}"
          echo "ðŸ“ Hostname: $(hostname)"
          echo "ðŸ–¥ï¸  OS: $(uname -s)"

      - name: ðŸ”§ Fix Git Config for HTTPS Checkout
        run: |
          echo "ðŸ”„ Configuring Git for HTTPS checkout..."
          git config --global --unset-all url."git@github.com:".insteadOf || true
          echo "âœ… Git config ready"

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. Node.js Setup
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: ðŸ“¦ Install Firebase CLI
        run: |
          echo "ðŸ“¦ Installing Firebase CLI..."
          npm install -g firebase-tools
          firebase --version
          echo "âœ… Firebase CLI installed"

      # 3. Environment Configuration
      - name: âš™ï¸ Configure Environment
        id: config
        run: |
          echo "âš™ï¸ Configuring deployment environment..."

          case "${{ inputs.environment }}" in
            production)
              if [ -z "${{ secrets.firebase_project_prod }}" ]; then
                echo "âŒ Firebase project ID for production not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_prod }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.prod.json" >> $GITHUB_OUTPUT
              ;;
            staging)
              if [ -z "${{ secrets.firebase_project_staging }}" ]; then
                echo "âŒ Firebase project ID for staging not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_staging }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.staging.json" >> $GITHUB_OUTPUT
              ;;
            development|*)
              if [ -z "${{ secrets.firebase_project_dev }}" ]; then
                echo "âŒ Firebase project ID for development not set"
                exit 1
              fi
              echo "project_id=${{ secrets.firebase_project_dev }}" >> $GITHUB_OUTPUT
              echo "config_file=firebase.dev.json" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "âœ… Environment configured"

      # 4. Install Dependencies
      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing Firebase functions dependencies..."
          cd "${{ inputs.functions_dir }}"
          npm ci
          npm run build 2>/dev/null || echo "âš ï¸ Build step not found or failed, continuing..."
          cd -
          echo "âœ… Dependencies installed"

      # 5. Deploy Firebase Functions
      - name: ðŸš€ Deploy Firebase Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.firebase_token }}
        run: |
          echo "ðŸš€ Deploying Firebase Functions..."
          echo "ðŸ“ Project: ${{ steps.config.outputs.project_id }}"
          echo "ðŸ“ Environment: ${{ inputs.environment }}"

          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "âŒ FIREBASE_TOKEN is not set"
            exit 1
          fi

          # Copy environment-specific config if it exists
          if [ -f "${{ steps.config.outputs.config_file }}" ]; then
            echo "ðŸ“‹ Using environment config: ${{ steps.config.outputs.config_file }}"
            cp "${{ steps.config.outputs.config_file }}" firebase.json
          fi

          # Deploy functions with explicit project
          firebase deploy \
            --project="${{ steps.config.outputs.project_id }}" \
            --token="$FIREBASE_TOKEN" \
            --only=functions \
            --message="Functions deployment from GitHub Actions for ${{ inputs.project_name }} to ${{ inputs.environment }}" \
            --non-interactive

          echo "âœ… Functions deployed successfully"

      # 6. Deploy Firestore Rules (if specified)
      - name: ðŸ“‹ Deploy Firestore Rules
        if: inputs.deploy_rules == true
        env:
          FIREBASE_TOKEN: ${{ secrets.firebase_token }}
        run: |
          echo "ðŸ“‹ Deploying Firestore Rules..."

          if [ ! -f "firestore.rules" ]; then
            echo "âš ï¸ firestore.rules not found, skipping rules deployment"
            exit 0
          fi

          firebase deploy \
            --project="${{ steps.config.outputs.project_id }}" \
            --token="$FIREBASE_TOKEN" \
            --only=firestore:rules \
            --message="Firestore rules deployment from GitHub Actions for ${{ inputs.project_name }} to ${{ inputs.environment }}" \
            --non-interactive

          echo "âœ… Firestore rules deployed successfully"

      # 7. Deploy Firestore Indexes (if they exist)
      - name: ðŸ“‘ Deploy Firestore Indexes
        if: inputs.deploy_rules == true
        env:
          FIREBASE_TOKEN: ${{ secrets.firebase_token }}
        run: |
          echo "ðŸ“‘ Deploying Firestore Indexes..."

          if [ ! -f "firestore.indexes.json" ]; then
            echo "âš ï¸ firestore.indexes.json not found, skipping indexes deployment"
            exit 0
          fi

          firebase deploy \
            --project="${{ steps.config.outputs.project_id }}" \
            --token="$FIREBASE_TOKEN" \
            --only=firestore:indexes \
            --message="Firestore indexes deployment from GitHub Actions for ${{ inputs.project_name }} to ${{ inputs.environment }}" \
            --non-interactive

          echo "âœ… Firestore indexes deployed successfully"

      # 8. Reporting
      - name: ðŸ“Š Deployment Summary
        if: success()
        run: |
          echo "## âœ… Firebase Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Firebase Project**: ${{ steps.config.outputs.project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Firebase Functions deployed and ready to use." >> $GITHUB_STEP_SUMMARY

      - name: âš ï¸ Deployment Failure Summary
        if: failure()
        run: |
          echo "## âŒ Firebase Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For debugging:" >> $GITHUB_STEP_SUMMARY
          echo "- Check FIREBASE_TOKEN is set correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Check Firebase project IDs in secrets" >> $GITHUB_STEP_SUMMARY
          echo "- Check functions build output" >> $GITHUB_STEP_SUMMARY
          echo "- See docs/TROUBLESHOOTING.md in nelson-grey repository" >> $GITHUB_STEP_SUMMARY

      # 9. Cache Cleanup
      - name: ðŸ§¹ Clean npm Cache
        if: always()
        run: npm cache clean --force 2>/dev/null || true
